// Prisma schema for Bravito After School - MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  password       String?   // null for Google-only users
  name           String?
  image          String?
  role           Role      @default(TEACHER)
  emailVerified  DateTime?
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  teacherGroups  Group[]         @relation("TeacherGroups")
  makeupLessons  MakeupLesson[]  @relation("TeacherMakeups")
  notifications  Notification[]  @relation("UserNotifications")

  @@map("users")
}

enum Role {
  ADMIN
  MANAGER
  TEACHER
}

// ==================== COURSES ====================

model Course {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  slug             String    @unique
  descriptionShort String
  descriptionLong  String?
  category         String?
  level            String?   // "Începător", "Intermediar", "Avansat"
  ageMin           Int?
  ageMax           Int?
  duration         String?   // "60 min", "90 min"
  lessonsCount     Int?
  price            Float     @default(0)
  discountPrice    Float?    // Prețul redus (opțional)
  seatsTotal       Int       @default(10)
  active           Boolean   @default(true)
  imageUrl         String?   // Imagine principală (deprecated, se folosește mainImageUrl)
  mainImageUrl     String?   // Imaginea principală selectată
  images           String[]  // Array de URL-uri pentru toate imaginile
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  enrollments Enrollment[]
  groups      Group[]
  reviews     Review[]

  @@map("courses")
}

// ==================== ENROLLMENTS (LEADS) ====================

model Enrollment {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  courseId      String           @db.ObjectId
  studentName   String
  studentAge    Int?
  parentName    String
  parentPhone   String
  parentEmail   String
  city          String?
  observations  String?
  status        EnrollmentStatus @default(NEW)
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("enrollments")
}

enum EnrollmentStatus {
  NEW
  CONTACTED
  CONFIRMED
  REJECTED
}

// ==================== STUDENTS ====================

model Student {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  fullName     String
  age          Int?
  parentName   String?
  parentPhone  String?
  parentEmail  String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  groupStudents        GroupStudent[]
  attendances          Attendance[]
  lessonTransactions   LessonTransaction[]
  makeupLessonStudents MakeupLessonStudent[]
  notifications        Notification[]

  @@map("students")
}

// ==================== GROUPS ====================

model Group {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  courseId        String   @db.ObjectId
  teacherId       String   @db.ObjectId
  scheduleDays    String[] // ["Mon", "Wed"]
  scheduleTime    String?  // "18:00"
  locationType    String?  // "offline" / "online"
  locationDetails String?  // Sala/Link
  startDate       DateTime?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher             User                @relation("TeacherGroups", fields: [teacherId], references: [id], onDelete: Cascade)
  groupStudents       GroupStudent[]
  lessonSessions      LessonSession[]
  lessonTransactions  LessonTransaction[]
  makeupLessons       MakeupLesson[]
  missedSessions      MissedSession[]

  @@map("groups")
}

// ==================== GROUP-STUDENT PIVOT ====================

model GroupStudent {
  id               String             @id @default(auto()) @map("_id") @db.ObjectId
  groupId          String             @db.ObjectId
  studentId        String             @db.ObjectId
  lessonsRemaining Int                @default(0)
  absences         Int                @default(0)
  status           GroupStudentStatus @default(ACTIVE)
  statusNote       String?            // Motiv pentru plecare/pauză
  statusChangedAt  DateTime?          // Când s-a schimbat statusul
  enrolledAt       DateTime           @default(now())

  // Relations
  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student  Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@unique([groupId, studentId])
  @@map("group_students")
}

enum GroupStudentStatus {
  ACTIVE    // Activ - participă la lecții
  PAUSED    // Pauză temporară
  LEFT      // A plecat din grupă
  COMPLETED // A terminat cursul
}

// ==================== LESSON SESSIONS ====================

model LessonSession {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId         String   @db.ObjectId
  date            DateTime
  notes           String?
  lessonsDeducted Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relations
  group               Group               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  attendances         Attendance[]
  lessonTransactions  LessonTransaction[]

  @@map("lesson_sessions")
}

// ==================== ATTENDANCE ====================

model Attendance {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  sessionId String           @db.ObjectId
  studentId String           @db.ObjectId
  status    AttendanceStatus @default(ABSENT)
  notes     String?
  createdAt DateTime         @default(now())

  // Relations
  session LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

// ==================== LESSON TRANSACTIONS (AUDIT) ====================

model LessonTransaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  groupId   String   @db.ObjectId
  sessionId String?  @db.ObjectId
  delta     Int      // -1 for deduction, +1 for addition
  reason    String?
  createdAt DateTime @default(now())

  // Relations
  student Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  session LessonSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@map("lesson_transactions")
}

// ==================== MAKEUP LESSONS ====================

model MakeupLesson {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  groupId           String             @db.ObjectId
  teacherId         String             @db.ObjectId
  scheduledAt       DateTime
  status            MakeupLessonStatus @default(SCHEDULED)
  notes             String?
  lessonsDeducted   Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  group           Group                 @relation(fields: [groupId], references: [id], onDelete: Cascade)
  teacher         User                  @relation("TeacherMakeups", fields: [teacherId], references: [id], onDelete: Cascade)
  students        MakeupLessonStudent[]

  @@map("makeup_lessons")
}

model MakeupLessonStudent {
  id             String                     @id @default(auto()) @map("_id") @db.ObjectId
  makeupLessonId String                     @db.ObjectId
  studentId      String                     @db.ObjectId
  status         MakeupLessonStudentStatus  @default(PENDING)
  notes          String?
  createdAt      DateTime                   @default(now())

  // Relations
  makeupLesson MakeupLesson @relation(fields: [makeupLessonId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([makeupLessonId, studentId])
  @@map("makeup_lesson_students")
}

enum MakeupLessonStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum MakeupLessonStudentStatus {
  PENDING
  PRESENT
  ABSENT
}

// ==================== REVIEWS ====================

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  authorName String
  roleLabel  String?  // "Părinte", "Elev"
  rating     Int      @default(5) // 1-5
  message    String
  avatarUrl  String?
  courseId   String?  @db.ObjectId
  published  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  course Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@map("reviews")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  type        NotificationType
  title       String
  message     String
  link        String?          // URL pentru acțiune (ex: /admin/students/123)
  recipientId String?          @db.ObjectId // User ID (profesor/admin) sau null pentru toți adminii
  studentId   String?          @db.ObjectId // Elev relevant (opțional)
  groupId     String?          @db.ObjectId // Grupă relevantă (opțional)
  data        Json?            // Date adiționale (lessonsRemaining, etc.)
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  // Relations
  recipient User?    @relation("UserNotifications", fields: [recipientId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([recipientId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  TEACHER_DAILY_SCHEDULE  // Profesorul are lecții azi
  LOW_LESSONS            // Elev cu puține lecții (sub 3)
  ZERO_LESSONS           // Elev cu 0 lecții
  NEGATIVE_LESSONS       // Elev cu lecții negative
  PAYMENT_RECEIVED       // Plată primită
  NEW_ENROLLMENT         // Înscriere nouă
  MISSED_SESSION         // Lecție ratată
  LATE_SESSION           // Lecție nepornită (2+ ore întârziere)
  CANCELLED_SESSION      // Lecție anulată de profesor
}

// ==================== PAYMENTS ====================

model Payment {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  groupStudentId String        @db.ObjectId
  amount         Float         // Suma achitată (RON)
  paymentDate    DateTime      @default(now())
  paymentMethod  String?       // "cash", "card", "transfer"
  notes          String?       // Notițe adiționale
  lessonsAdded   Int?          // Câte lecții s-au adăugat pentru această plată
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  groupStudent GroupStudent @relation(fields: [groupStudentId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ==================== INSCRIERI (FORMULARE PUBLICE) ====================

model Inscriere {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  numeParinte  String
  numeCopil    String
  email        String
  telefon      String
  clasa        String
  cursuri      String[]
  mesaj        String?
  status       InscriereStatus @default(NOU)
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@map("inscrieri")
}

enum InscriereStatus {
  NOU
  CONTACTAT
  CONFIRMAT
  RESPINS
}

// ==================== CONTACT MESSAGES ====================

model ContactMessage {
  id        String               @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  phone     String?
  message   String
  status    ContactMessageStatus @default(NOU)
  notes     String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@map("contact_messages")
}

enum ContactMessageStatus {
  NOU
  CITIT
  RASPUNS
  ARHIVAT
}

// ==================== MISSED SESSIONS (LECȚII RATATE) ====================

model MissedSession {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId        String   @db.ObjectId
  scheduledDate  DateTime // Data și ora când trebuia să fie lecția
  scheduledDay   String   // Ziua programată (ex: "Mon", "Wed")
  scheduledTime  String   // Ora programată (ex: "18:00")
  reason         String?  // Motivul (ex: "Profesorul nu a pornit lecția la timp")
  acknowledged   Boolean  @default(false) // Dacă admin-ul a văzut/confirmat
  createdAt      DateTime @default(now())

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("missed_sessions")
}
